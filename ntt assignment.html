<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Team NTT Assignment</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; font-size: 14px; }
    .chip { padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; display: inline-block; }
    th, td { text-align: center; }
  </style>
</head>
<body class="h-dvh w-screen overflow-hidden bg-gray-100 text-gray-800 grid grid-rows-[auto,1fr]">

  <!-- Header -->
  <header class="bg-indigo-600 text-white px-4 sm:px-6 py-3 flex items-center justify-between shadow">
    <div class="flex items-center gap-3">
      <a href="./" class="text-white/80 hover:text-white text-sm">← Back</a>
      <div class="flex items-center gap-2">
        <svg class="w-5 h-5 opacity-90" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 3v18h18"></path>
          <rect x="7" y="8" width="3" height="8" rx="1"></rect>
          <rect x="12" y="5" width="3" height="11" rx="1"></rect>
          <rect x="17" y="11" width="3" height="5" rx="1"></rect>
        </svg>
        <h1 class="text-lg sm:text-xl font-bold tracking-wide">Team NTT Assignment</h1>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <div id="lastSynced" class="text-xs text-indigo-100"></div>
      <button id="btnSync" class="text-xs bg-white/10 hover:bg-white/20 px-2 py-1 rounded border border-white/20">⟳ Sync</button>
    </div>
  </header>

  <!-- Main -->
  <main class="min-h-0 overflow-hidden flex flex-col px-2 sm:px-6 py-4">

    <!-- Team Tabs -->
    <div class="mb-4 shrink-0">
      <div class="flex flex-wrap gap-2">
        <button data-team="" class="team-tab active bg-gray-200 hover:bg-gray-300 text-gray-800 rounded px-3 py-1 text-sm">All <span id="cnt-ALL" class="ml-1 text-xs text-gray-500">0</span></button>
        <button data-team="TEAM FAISON" class="team-tab bg-white hover:bg-gray-100 border rounded px-3 py-1 text-sm">Team Faison <span id="cnt-TEAM-FAISON" class="ml-1 text-xs text-gray-500">0</span></button>
        <button data-team="TEAM FAUZIE" class="team-tab bg-white hover:bg-gray-100 border rounded px-3 py-1 text-sm">Team Fauzie <span id="cnt-TEAM-FAUZIE" class="ml-1 text-xs text-gray-500">0</span></button>
        <button data-team="TEAM RUDI" class="team-tab bg-white hover:bg-gray-100 border rounded px-3 py-1 text-sm">Team Rudi <span id="cnt-TEAM-RUDI" class="ml-1 text-xs text-gray-500">0</span></button>
        <button data-team="TEAM ROSDEE" class="team-tab bg-white hover:bg-gray-100 border rounded px-3 py-1 text-sm">Team Rosdee <span id="cnt-TEAM-ROSDEE" class="ml-1 text-xs text-gray-500">0</span></button>
      </div>
    </div>

    <!-- Domain filter + bulk actions -->
    <div class="bg-white border rounded-lg p-3 sm:p-4 shadow-sm mb-4 shrink-0">
      <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 justify-between">
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-600">Domain:</label>
          <select id="filterDomain" class="border rounded px-2 py-1 text-sm min-w-[220px]">
            <option value="">All domains</option>
          </select>
        </div>
        <div class="flex-1"></div>
        <div class="flex flex-wrap items-center gap-2">
          <div class="flex items-center gap-2">
            <input id="selectAll" type="checkbox" class="w-4 h-4">
            <label for="selectAll" class="text-sm text-gray-700">Select all on page</label>
          </div>
          <div class="hidden sm:block w-px h-6 bg-gray-200 mx-1"></div>
          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-600">Assign to:</label>
            <select id="bulkTeam" class="border rounded px-2 py-1 text-sm">
              <option value="">Choose team…</option>
              <option value="TEAM FAISON">Team Faison</option>
              <option value="TEAM FAUZIE">Team Fauzie</option>
              <option value="TEAM RUDI">Team Rudi</option>
              <option value="TEAM ROSDEE">Team Rosdee</option>
            </select>
            <button id="btnBulkAssign" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded px-3 py-1.5 text-sm">Assign</button>
          </div>
          <div class="hidden sm:block w-px h-6 bg-gray-200 mx-1"></div>
          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-600">Status:</label>
            <select id="bulkStatus" class="border rounded px-2 py-1 text-sm">
              <option value="">Choose status…</option>
              <option value="UNASSIGNED">Unassigned</option>
              <option value="ASSIGNED">Assigned</option>
              <option value="IN PROGRESS">In Progress</option>
              <option value="RESOLVED">Resolved</option>
            </select>
            <button id="btnBulkStatus" class="bg-slate-600 hover:bg-slate-700 text-white rounded px-3 py-1.5 text-sm">Update Status</button>
          </div>
          <div class="hidden sm:block w-px h-6 bg-gray-200 mx-1"></div>
          <button id="btnExport" class="bg-emerald-600 hover:bg-emerald-700 text-white rounded px-3 py-1.5 text-sm">Export Assignments CSV</button>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="bg-white border rounded-lg overflow-hidden shadow-sm flex-1 flex flex-col min-h-0">
      <div class="flex-1 min-h-0 overflow-auto">
        <table class="min-w-full w-full text-sm" id="tbl">
          <thead class="bg-white text-gray-600 uppercase text-xs sticky top-0 z-10">
            <tr>
              <th class="px-3 py-2 w-10"></th>
              <th class="px-3 py-2">NTT</th>
              <th class="px-3 py-2">Date</th>
              <th class="px-3 py-2">TM Node</th>
              <th class="px-3 py-2">Network ID</th>
              <th class="px-3 py-2 hidden md:table-cell">Domain</th>
              <th class="px-3 py-2 hidden sm:table-cell">Aging</th>
              <th class="px-3 py-2 hidden sm:table-cell">Assignee</th>
              <th class="px-3 py-2">Status</th>
              <th class="px-3 py-2 hidden sm:table-cell">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <p class="text-xs text-gray-500 mt-3 shrink-0">Assignments & statuses are saved locally in your browser (localStorage). <span class="font-semibold">Changes are auto-saved.</span></p>
  </main>

  <!-- Description Modal -->
  <div id="descModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl" role="dialog" aria-modal="true">
      <div class="flex items-center justify-between border-b px-4 py-2">
        <h3 class="text-base font-semibold">Description</h3>
        <button id="closeDesc" class="px-2 py-1 text-sm text-gray-500 hover:text-gray-700" aria-label="Close">✕</button>
      </div>
      <div class="p-4">
        <pre id="descText" class="whitespace-pre-wrap bg-gray-100 rounded p-3 text-sm overflow-y-auto max-h-[60vh]"></pre>
        <div class="mt-3 text-right">
          <button id="closeDesc2" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded px-3 py-1.5 text-sm">Close</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== Shared storage contract (same as Log Viewer) ===== */
const ASSIGN_KEY = "nttAssignments";
const ASSIGN_VER_KEY = "nttAssignmentsVersion";
/* entry: { team, note, status: "assigned"|"done", at, doneAt } */

/* ===== Config ===== */
const REPO_RAW_URL = "https://raw.githubusercontent.com/jadyakub/ntt-data/main/ntt_logs.csv";
const ALLOWED_NODES = ["KGU","TBN","SOO","NBN","TNM"];
const AUTO_REFRESH_SECONDS = 30;

/* ===== State ===== */
let fullData = [];
let dataByNtt = {};
let currentTeamFilter = "";
let currentDomainFilter = "";

/* ===== Utils ===== */
const cloudUrl = () => `${REPO_RAW_URL}?nocache=${Date.now()}`;
const normalize = s => (s||"").toString().trim();
const idForTeam = t => (t||"ALL").toUpperCase().replace(/\s+/g,"-");
const escapeHtml = s => (s??"").toString().replace(/[&<>\"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));
const shorten = (s,n) => (s||"").length>n ? s.slice(0,n-1)+"…" : (s||"");
const getDescription = row => row["Description"] || row["Problem Description"] || row["NTT Description"] || row["Remark"] || row["Remarks"] || "";

/* ===== Storage helpers ===== */
function readAssignments(){ try { return JSON.parse(localStorage.getItem(ASSIGN_KEY)||"{}"); } catch { return {}; } }
function writeAssignments(obj){ localStorage.setItem(ASSIGN_KEY, JSON.stringify(obj)); localStorage.setItem(ASSIGN_VER_KEY, String(Date.now())); }
function saveAssignment(ntt, team, note=""){
  const data = readAssignments();
  data[ntt] = { team, note, status: "assigned", at: data[ntt]?.at || new Date().toISOString(), doneAt: null };
  writeAssignments(data);
}
function setDone(ntt, done=true){
  const data = readAssignments();
  if (!data[ntt]) return;
  data[ntt].status = done ? "done" : "assigned";
  data[ntt].doneAt = done ? new Date().toISOString() : null;
  writeAssignments(data);
}
function unassign(ntt){
  const data = readAssignments();
  delete data[ntt];
  writeAssignments(data);
}
function uiStatusFromStorage(entry){ return !entry ? "UNASSIGNED" : (entry.status==="done" ? "RESOLVED" : "ASSIGNED"); }

/* ===== Filters ===== */
function populateDomainFilter(rows){
  const sel = document.getElementById("filterDomain");
  const domains = Array.from(new Set(rows.map(r => normalize(r["Domain"])).filter(Boolean))).sort();
  sel.innerHTML = `<option value="">All domains</option>` + domains.map(d => `<option>${d}</option>`).join("");
}

/* ===== Loader ===== */
async function loadFromGitHub(first=false){
  const txt = await fetch(cloudUrl(), { cache: "no-store" }).then(r => r.text());
  const parsed = Papa.parse(txt, { header: true, skipEmptyLines: true });
  fullData = parsed.data
    .filter(r => ALLOWED_NODES.includes((r["TM Node"]||"").toUpperCase()))
    .filter(r => (r["NTT Number"]||"").trim().length > 0);

  dataByNtt = Object.fromEntries(fullData.map(r => [ (r["NTT Number"]||"").trim(), r ]));
  populateDomainFilter(fullData);
  render();

  const ls = document.getElementById("lastSynced");
  if (ls) ls.textContent = "Synced: " + new Date().toLocaleString();
}

/* ===== Init ===== */
document.addEventListener("DOMContentLoaded", async () => {
  const params = new URLSearchParams(location.search);
  const presetTeam = params.get("team");
  if (presetTeam) currentTeamFilter = presetTeam.toUpperCase();

  await loadFromGitHub(true);
  wireUI();

  // Auto-refresh, manual, and on refocus
  setInterval(loadFromGitHub, AUTO_REFRESH_SECONDS * 1000);
  document.getElementById("btnSync").addEventListener("click", () => loadFromGitHub(true));
  document.addEventListener("visibilitychange", () => { if (!document.hidden) loadFromGitHub(); });
});

/* ===== UI wiring ===== */
function wireUI(){
  document.querySelectorAll(".team-tab").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".team-tab").forEach(b => b.classList.remove("active","bg-gray-200","text-gray-800"));
      btn.classList.add("active","bg-gray-200","text-gray-800");
      currentTeamFilter = (btn.dataset.team || "");
      render();
    });
  });

  const domSel = document.getElementById("filterDomain");
  if (domSel) domSel.addEventListener("change", e => { currentDomainFilter = e.target.value || ""; render(); });

  document.getElementById("selectAll").addEventListener("change", e => {
    document.querySelectorAll('.row-check').forEach(cb => cb.checked = e.target.checked);
  });

  document.getElementById("btnBulkAssign").addEventListener("click", () => {
    const team = document.getElementById("bulkTeam").value;
    if (!team) return alert("Pick a team to assign.");
    const ids = getSelectedRows();
    if (!ids.length) return alert("No rows selected.");
    ids.forEach(ntt => saveAssignment(ntt, team));
    render();
  });

  document.getElementById("btnBulkStatus").addEventListener("click", () => {
    const ui = document.getElementById("bulkStatus").value;
    if (!ui) return alert("Pick a status.");
    const ids = getSelectedRows();
    if (!ids.length) return alert("No rows selected.");

    if (ui === "UNASSIGNED") ids.forEach(unassign);
    else if (ui === "RESOLVED") ids.forEach(id => setDone(id, true));
    else ids.forEach(id => setDone(id, false)); // ASSIGNED / IN PROGRESS

    render();
  });

  document.getElementById("btnExport").addEventListener("click", exportAssignmentsCSV);

  /* === FIXED: per-row change handling === */
  document.addEventListener('change', (e) => {
    const tr = e.target.closest('tr');
    if (!tr) return;
    const ntt = tr.querySelector('.row-check')?.dataset.ntt;

    // Team changed -> ALWAYS create/update as assigned
    if (e.target.classList.contains('row-assign')) {
      const team = e.target.value || "";
      if (!team) unassign(ntt);
      else { saveAssignment(ntt, team); setDone(ntt, false); }
      render();
      return;
    }

    // Status changed
    if (e.target.classList.contains('row-status')) {
      const val = e.target.value || "UNASSIGNED";
      if (val === "UNASSIGNED") unassign(ntt);
      else if (val === "RESOLVED") setDone(ntt, true);
      else setDone(ntt, false); // ASSIGNED / IN PROGRESS
      render();
    }
  });

  // Description modal
  document.addEventListener('click', (e) => {
    const link = e.target.closest('.ntt-link');
    if (link) {
      const ntt = link.dataset.ntt;
      const row = dataByNtt[ntt] || {};
      const desc = getDescription(row) || 'No description available.';
      showDescModal(desc);
    }
    if (e.target.id === 'closeDesc' || e.target.id === 'closeDesc2' || e.target.id === 'descModal') hideDescModal();
  });

  // cross-tab sync
  window.addEventListener('storage', (ev) => {
    if (ev.key === ASSIGN_KEY || ev.key === ASSIGN_VER_KEY) render();
  });
}

/* ===== Render ===== */
function render(){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  const baseRows = fullData.filter(row => {
    const domain = normalize(row["Domain"]);
    return !currentDomainFilter || domain === currentDomainFilter;
  });

  const counts = { ALL:0, "TEAM FAISON":0, "TEAM FAUZIE":0, "TEAM RUDI":0, "TEAM ROSDEE":0 };

  const rows = baseRows.map(row => {
    const ntt = (row["NTT Number"]||"").trim();
    const entry = readAssignments()[ntt];
    const team = entry?.team || "";
    const status = uiStatusFromStorage(entry);
    if (counts[team||""] !== undefined) counts[team||""]++;
    counts.ALL++;
    return {
      ntt,
      date: row["NTT Create Date"] || "",
      node: row["TM Node"] || "",
      networkId: row["Network ID"] || "",
      domain: row["Domain"] || "",
      aging: row["Aging Category"] || "",
      team, status
    };
  });

  document.getElementById("cnt-ALL").textContent = counts.ALL || 0;
  ["TEAM FAISON","TEAM FAUZIE","TEAM RUDI","TEAM ROSDEE"].forEach(t => {
    const el = document.getElementById("cnt-"+idForTeam(t)); if (el) el.textContent = counts[t] || 0;
  });

  const filtered = rows.filter(r => !currentTeamFilter || r.team === currentTeamFilter);

  filtered.forEach(r => {
    const tr = document.createElement("tr");
    tr.className = "border-b hover:bg-gray-50";
    tr.innerHTML = `
      <td class="px-3 py-2 align-top"><input type="checkbox" class="row-check w-4 h-4" data-ntt="${escapeHtml(r.ntt)}"></td>
      <td class="px-3 py-2 align-top">
        <button class="ntt-link font-semibold text-indigo-700 underline-offset-2 hover:underline" data-ntt="${escapeHtml(r.ntt)}">${escapeHtml(r.ntt)}</button>
        <div class="text-xs text-gray-500">${escapeHtml(shorten(r.domain, 36))}</div>
      </td>
      <td class="px-3 py-2 align-top">${escapeHtml(r.date)}</td>
      <td class="px-3 py-2 align-top">${escapeHtml(r.node)}</td>
      <td class="px-3 py-2 align-top">${escapeHtml(r.networkId)}</td>
      <td class="px-3 py-2 align-top hidden md:table-cell">${escapeHtml(r.domain)}</td>
      <td class="px-3 py-2 align-top hidden sm:table-cell">${agingChip(r.aging)}</td>
      <td class="px-3 py-2 align-top hidden sm:table-cell">${teamChip(r.team || "")}</td>
      <td class="px-3 py-2 align-top">${statusChip(r.status)}</td>
      <td class="px-3 py-2 align-top hidden sm:table-cell">
        <div class="flex flex-wrap gap-2">
          <select class="row-assign border rounded px-2 py-1 text-xs" data-ntt="${escapeHtml(r.ntt)}">
            <option value="">— Assign team —</option>
            <option value="TEAM FAISON" ${r.team==="TEAM FAISON"?"selected":""}>Team Faison</option>
            <option value="TEAM FAUZIE" ${r.team==="TEAM FAUZIE"?"selected":""}>Team Fauzie</option>
            <option value="TEAM RUDI" ${r.team==="TEAM RUDI"?"selected":""}>Team Rudi</option>
            <option value="TEAM ROSDEE" ${r.team==="TEAM ROSDEE"?"selected":""}>Team Rosdee</option>
          </select>
          <select class="row-status border rounded px-2 py-1 text-xs" data-ntt="${escapeHtml(r.ntt)}">
            ${["UNASSIGNED","ASSIGNED","IN PROGRESS","RESOLVED"].map(s => `<option ${s===r.status?"selected":""}>${s}</option>`).join("")}
          </select>
        </div>
      </td>`;
    tbody.appendChild(tr);
  });

  const selectAll = document.getElementById("selectAll");
  if (selectAll) selectAll.checked = false;
}

/* ===== UI helpers ===== */
function agingChip(aging){
  const map={ "> 48H":"bg-red-500 text-white","24H - 48H":"bg-orange-500 text-white","12H - 24H":"bg-amber-400 text-gray-900","8H - 12H":"bg-yellow-300 text-gray-900","< 8H":"bg-emerald-400 text-gray-900" };
  const cls=map[aging]||"bg-gray-200 text-gray-700";
  return `<span class="chip ${cls}">${escapeHtml(aging||"N/A")}</span>`;
}
function statusChip(status){
  const map={ "UNASSIGNED":"bg-gray-200 text-gray-800","ASSIGNED":"bg-indigo-200 text-indigo-800","IN PROGRESS":"bg-amber-200 text-amber-900","RESOLVED":"bg-emerald-200 text-emerald-900" };
  const cls=map[status]||"bg-gray-200 text-gray-800";
  return `<span class="chip ${cls}">${escapeHtml(status||"UNASSIGNED")}</span>`;
}
function teamChip(team){
  if(!team) return `<span class="chip bg-gray-100 text-gray-600">Unassigned</span>`;
  const map={ "TEAM FAISON":"bg-fuchsia-100 text-fuchsia-800","TEAM FAUZIE":"bg-sky-100 text-sky-800","TEAM RUDI":"bg-rose-100 text-rose-800","TEAM ROSDEE":"bg-teal-100 text-teal-800" };
  const cls=map[team]||"bg-gray-100 text-gray-700";
  return `<span class="chip ${cls}">${escapeHtml(team)}</span>`;
}

/* ===== Selection & Export ===== */
function getSelectedRows(){ return Array.from(document.querySelectorAll('.row-check:checked')).map(cb => cb.dataset.ntt); }
function exportAssignmentsCSV(){
  const data = readAssignments();
  const rows = Object.entries(data).map(([ntt, v]) => ({
    NTT: ntt, Team: v.team||"", Status: v.status==="done"?"RESOLVED":"ASSIGNED", UpdatedAt: v.doneAt||v.at||""
  }));
  const header="NTT,Team,Status,UpdatedAt\n";
  const body = rows.map(r => [r.NTT,r.Team,r.Status,r.UpdatedAt].map(x=>`"${(x||"").replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob=new Blob([header+body],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='ntt_assignments_export.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ===== Modal ===== */
function showDescModal(text){ const m=document.getElementById('descModal'); document.getElementById('descText').textContent=text; m.classList.remove('hidden'); m.classList.add('flex'); }
function hideDescModal(){ const m=document.getElementById('descModal'); m.classList.add('hidden'); m.classList.remove('flex'); }
</script>
</body>
</html>
