<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NTT Log Viewer + Team Assignment</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; font-size: 14px; }
    th, td { text-align: center; }
  </style>
</head>
<body class="min-h-screen bg-gray-100 text-gray-800">

  <!-- Header -->
  <header class="bg-indigo-600 text-white px-5 py-4 shadow flex items-center justify-between">
    <h1 class="text-lg font-bold tracking-wide">ðŸ“Š NTT Log Viewer + Assignment</h1>
    <div class="text-xs opacity-90">Netlify Functions demo</div>
  </header>

  <main class="max-w-7xl mx-auto p-4 space-y-4">

    <!-- Controls -->
    <section class="bg-white rounded-xl shadow p-4 grid gap-3 md:grid-cols-4">
      <div class="md:col-span-2">
        <label class="block text-sm font-semibold mb-1">Filter TM Node</label>
        <select id="nodeFilter" class="w-full border rounded-lg px-3 py-2">
          <option value="">All</option>
          <option>KGU</option><option>TBN</option><option>TNM</option><option>SOO</option><option>NBN</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Search</label>
        <input id="searchInput" class="w-full border rounded-lg px-3 py-2" placeholder="Find NTT / Domain / Network ID"/>
      </div>
      <div class="flex items-end gap-2">
        <button id="reloadBtn" class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Reload CSV</button>
        <button id="syncBtn" class="flex-1 bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700">Sync Assignments</button>
      </div>
    </section>

    <!-- Mini dashboard -->
    <section class="grid md:grid-cols-4 gap-3">
      <div class="bg-white rounded-xl shadow p-4">
        <div class="text-sm text-gray-500">Team Faison</div>
        <div id="cFaison" class="text-2xl font-bold">0</div>
      </div>
      <div class="bg-white rounded-xl shadow p-4">
        <div class="text-sm text-gray-500">Team Fauzie</div>
        <div id="cFauzie" class="text-2xl font-bold">0</div>
      </div>
      <div class="bg-white rounded-xl shadow p-4">
        <div class="text-sm text-gray-500">Team Rudi</div>
        <div id="cRudi" class="text-2xl font-bold">0</div>
      </div>
      <div class="bg-white rounded-xl shadow p-4">
        <div class="text-sm text-gray-500">Team Rosdee</div>
        <div id="cRosdee" class="text-2xl font-bold">0</div>
      </div>
    </section>

    <!-- Assignment bar -->
    <section class="bg-white rounded-xl shadow p-4 flex flex-col md:flex-row items-center gap-3">
      <div class="font-semibold">Assign selected to:</div>
      <select id="teamSelect" class="border rounded-lg px-3 py-2">
        <option value="">â€” choose team â€”</option>
        <option value="Team Faison">Team Faison</option>
        <option value="Team Fauzie">Team Fauzie</option>
        <option value="Team Rudi">Team Rudi</option>
        <option value="Team Rosdee">Team Rosdee</option>
      </select>
      <button id="assignBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Assign</button>
      <div class="text-xs text-gray-500 ml-auto">Tip: use the checkbox column to select rows</div>
    </section>

    <!-- Table -->
    <section class="bg-white rounded-xl shadow overflow-auto">
      <table class="min-w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-3 py-2"><input id="selectAll" type="checkbox"/></th>
            <th class="px-3 py-2">NTT Number</th>
            <th class="px-3 py-2">TM Node</th>
            <th class="px-3 py-2">Domain</th>
            <th class="px-3 py-2">Network ID</th>
            <th class="px-3 py-2">Assigned Team</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

  </main>

  <script>
    // ====== Config ======
    const cloudCSVUrl =
      "https://raw.githubusercontent.com/jadyakub/ntt-data/main/ntt_logs.csv?nocache=" + Date.now();

    const functionURL = "/.netlify/functions/assignments"; // GET / POST

    // ====== State ======
    let fullData = [];           // CSV rows
    let assignments = {};        // { nttNumber: "Team ..." }

    // ====== Helpers ======
    const $ = (id) => document.getElementById(id);

    function renderTable() {
      const node = $("nodeFilter").value.trim();
      const q = $("searchInput").value.trim().toLowerCase();

      const rows = fullData.filter(r => {
        const byNode = !node || (r["TM Node"] || r.Node || "").toUpperCase().startsWith(node.toUpperCase());
        const s = (r["NTT Number"] + " " + (r["TM Node"]||r.Node) + " " + r.Domain + " " + r["Network ID"]).toLowerCase();
        const bySearch = !q || s.includes(q);
        return byNode && bySearch;
      });

      const tb = $("tbody");
      tb.innerHTML = "";

      rows.forEach(r => {
        const ntt = (r["NTT Number"] || "").trim();
        const tr = document.createElement("tr");
        tr.className = "border-t";

        tr.innerHTML = `
          <td class="px-3 py-2"><input type="checkbox" data-ntt="${ntt}"/></td>
          <td class="px-3 py-2 font-semibold">${ntt}</td>
          <td class="px-3 py-2">${r["TM Node"] || r.Node || ""}</td>
          <td class="px-3 py-2">${r.Domain || ""}</td>
          <td class="px-3 py-2">${r["Network ID"] || ""}</td>
          <td class="px-3 py-2">${assignments[ntt] || "-"}</td>
        `;
        tb.appendChild(tr);
      });

      updateDashboardCounts();
    }

    function updateDashboardCounts() {
      const counts = { "Team Faison":0, "Team Fauzie":0, "Team Rudi":0, "Team Rosdee":0 };
      Object.values(assignments).forEach(t => { if (counts[t] !== undefined) counts[t]++; });
      $("cFaison").textContent = counts["Team Faison"];
      $("cFauzie").textContent = counts["Team Fauzie"];
      $("cRudi").textContent   = counts["Team Rudi"];
      $("cRosdee").textContent = counts["Team Rosdee"];
    }

    async function loadCSV() {
      return new Promise((resolve, reject) => {
        Papa.parse(cloudCSVUrl, {
          download: true,
          header: true,
          complete: (res) => resolve(res.data.filter(Boolean)),
          error: reject
        });
      });
    }

    async function loadAssignmentsFromAPI() {
      try {
        const res = await fetch(functionURL);
        if (!res.ok) throw new Error("GET failed");
        const data = await res.json();
        assignments = data.assignments || {};
        localStorage.setItem("assignments", JSON.stringify(assignments)); // cache
      } catch (e) {
        // Fallback to localStorage
        const cached = localStorage.getItem("assignments");
        assignments = cached ? JSON.parse(cached) : {};
        console.warn("Using localStorage fallback for assignments:", e.message);
      }
    }

    async function saveAssignmentsToAPI(newOnes) {
      try {
        const res = await fetch(functionURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ assignments: newOnes })
        });
        if (!res.ok) throw new Error("POST failed");
        const data = await res.json();
        assignments = data.assignments || assignments;
        localStorage.setItem("assignments", JSON.stringify(assignments));
        return true;
      } catch (e) {
        console.warn("API save failed, keeping local only:", e.message);
        // Merge to local fallback
        assignments = { ...assignments, ...newOnes };
        localStorage.setItem("assignments", JSON.stringify(assignments));
        return false;
      }
    }

    // ====== Events ======
    $("nodeFilter").addEventListener("change", renderTable);
    $("searchInput").addEventListener("input", renderTable);
    $("reloadBtn").addEventListener("click", async () => {
      fullData = await loadCSV();
      renderTable();
    });
    $("syncBtn").addEventListener("click", async () => {
      await loadAssignmentsFromAPI();
      renderTable();
    });

    $("selectAll").addEventListener("change", (e) => {
      document.querySelectorAll('#tbody input[type="checkbox"]').forEach(cb => cb.checked = e.target.checked);
    });

    $("assignBtn").addEventListener("click", async () => {
      const team = $("teamSelect").value;
      if (!team) { alert("Please choose a team first."); return; }

      const checked = Array.from(document.querySelectorAll('#tbody input[type="checkbox"]:checked'));
      if (checked.length === 0) { alert("Please select at least one row."); return; }

      const updates = {};
      checked.forEach(cb => { updates[cb.dataset.ntt] = team; });
      await saveAssignmentsToAPI(updates);
      renderTable();
      $("selectAll").checked = false;
    });

    // ====== Init ======
    (async () => {
      fullData = await loadCSV();
      await loadAssignmentsFromAPI();
      renderTable();
    })();

  </script>
</body>
</html>
