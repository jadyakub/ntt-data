<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NTT Log Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: 'Inter','Segoe UI',Tahoma,Geneva,Verdana,sans-serif; font-size:13px; }
    @media print {
      header,.shadow,.rounded-xl,input,select,button,#searchInput,#descriptionModal,#summaryDashboard,#assignModal,script{display:none!important}
      main{padding:0;background:#fff;box-shadow:none}
      table{font-size:12px} th,td{padding:4px 8px!important}
    }
    @media (hover:none) and (pointer:coarse), screen and (max-width:640px){
      :root{--m-pad:12px}
      main,header,.team-section,.grid,table,.overflow-x-auto{width:100%!important;max-width:100%!important}
      body{overflow-x:hidden}
      header{display:flex!important;flex-direction:column!important;align-items:stretch!important;gap:.5rem!important;padding:var(--m-pad)!important}
      nav{display:flex!important;flex-direction:row;gap:1rem;margin-top:.5rem}
      main>.grid:first-of-type{display:flex!important;flex-direction:column!important;gap:.5rem!important}
      main>.grid:first-of-type .grid{display:flex!important;flex-direction:column!important;gap:.5rem!important}
      #summaryDashboard{display:flex!important;flex-direction:column!important;gap:.75rem!important}
      .overflow-x-auto{overflow-x:auto!important;-webkit-overflow-scrolling:touch}
      #logTable{min-width:720px}
      #logTable th,#logTable td{text-align:center;white-space:nowrap}
      /* kekalkan modal assign berada di tengah pada mobile juga */
      #assignModal{align-items:center!important;padding-top:var(--m-pad)!important}
      #assignModal>div{width:100%!important;max-width:none!important;border-radius:.75rem!important}
    }
    #logTable th,#logTable td{text-align:center}
    #logTable thead th{position:sticky;top:0;z-index:5;background:#e5e7eb}
    #toast{position:fixed;bottom:16px;right:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 10px 20px rgba(0,0,0,.25);opacity:0;transform:translateY(10px);pointer-events:none;transition:opacity .2s,transform .2s;font-size:12px}
    #toast.show{opacity:1;transform:translateY(0)}
    .tabbtn.active { background:#e0e7ff; border-color:#6366f1; color:#1f2937; font-weight:600; }
    #dashTabs{ position: static; top: auto; z-index: auto; background: transparent; padding: 0 0 .5rem; box-shadow: none; border-bottom: 0; }
    #dashTabs.stuck{ box-shadow:none; border-bottom:0; }
    .card-soft { border-radius:14px; background:#fff; border:1px solid #e5e7eb; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .pill { display:inline-flex; align-items:center; gap:.5rem; padding:.25rem .6rem; border-radius:9999px; font-weight:600; font-size:12px; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <header class="bg-indigo-700 text-white px-6 py-4 shadow flex flex-wrap gap-3 items-center justify-between">
    <h1 class="text-xl font-bold tracking-wide">üìä NTT Log Viewer</h1>
    <div class="flex items-center gap-3">
      <div id="lastUpdated" class="text-sm text-gray-100"></div>
    </div>
  </header>

  <main class="w-full min-h-screen px-2 sm:px-6 lg:px-8 py-6 bg-white shadow rounded-xl">

    <!-- Filters -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-4">
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <select id="filterNode" class="border border-gray-300 rounded px-2 py-2 shadow-sm">
          <option value="">Filter by TM Node</option>
          <option value="KGU">KGU</option><option value="TBN">TBN</option>
          <option value="SOO">SOO</option><option value="NBN">NBN</option><option value="TNM">TNM</option>
        </select>
        <select id="filterDomain" class="border border-gray-300 rounded px-2 py-2 shadow-sm"><option value="">Filter by Domain</option></select>
        <select id="filterAging" class="border border-gray-300 rounded px-2 py-2 shadow-sm"><option value="">Filter by Aging</option></select>
      </div>
    </div>

    <div class="mb-4">
      <input id="searchInput" type="text" placeholder="üîç Search keyword (e.g., dp faulty)" class="w-full border border-gray-300 rounded px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400"/>
    </div>

    <!-- DASHBOARD TABS (STATIK) -->
    <div id="dashTabs" class="mb-4 flex flex-wrap gap-2">
      <button data-show="summary" class="tabbtn px-3 py-1.5 rounded border bg-white text-gray-700 hover:bg-indigo-50">Summary</button>
      <button data-show="zoneOnly" class="tabbtn px-3 py-1.5 rounded border bg-white text-gray-700 hover:bg-indigo-50">Zone View</button>
      <button data-show="summaryDashboard" class="tabbtn px-3 py-1.5 rounded border bg-white text-gray-700 hover:bg-indigo-50">Team View</button>
    </div>

    <!-- SUMMARY GRID (KPI + ZONE LEFT, TEAM QUICK RIGHT) -->
    <div id="summaryGrid" class="grid grid-cols-1 lg:grid-cols-12 gap-4 mb-6">
      <!-- LEFT: KPI + ZONE -->
      <div class="lg:col-span-8 space-y-4">
        <div id="nttSummary" class="card-soft p-4">
          <h2 class="text-lg font-semibold text-gray-700 mb-3">NTT Summary</h2>
          <div id="nttSummaryContainer" class="grid grid-cols-2 sm:grid-cols-4 gap-4"></div>
        </div>

        <div id="zoneCard" class="card-soft p-4">
          <h2 class="text-lg font-semibold text-gray-700 mb-3">üìç Zone Summary ‚Äî PBP SELATAN: Passive Element Nova</h2>
          <div id="zoneDashboard" class="space-y-3"></div>
          <div id="zoneGrand" class="flex justify-between mt-4 pt-3 border-t text-sm font-semibold text-gray-700"></div>
        </div>
      </div>

      <!-- RIGHT: TEAM QUICK PANEL -->
      <aside id="teamQuickPanel" class="lg:col-span-4 space-y-3"></aside>
    </div>

    <!-- TEAM VIEW CARDS (compact) -->
    <div id="summaryDashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 text-sm"></div>

    <!-- TABLE -->
    <div class="overflow-x-auto text-sm">
      <table class="min-w-full table-auto border-collapse text-center" id="logTable">
        <thead class="bg-gray-200 text-sm uppercase tracking-wider">
          <tr>
            <th class="px-4 py-2">Date</th>
            <th class="px-4 py-2">NTT Number</th>
            <th class="px-4 py-2">TM Node</th>
            <th class="px-4 py-2">Symptom</th>
            <th class="px-4 py-2">Domain</th>
            <th class="px-4 py-2">Network ID</th>
            <th class="px-4 py-2">CTTs Linked</th>
            <th class="px-4 py-2">Aging</th>
            <th class="px-4 py-2">Days</th>
            <th class="px-4 py-2 hidden sm:table-cell">Assignee</th>
            <th class="px-4 py-2 hidden sm:table-cell">Status</th>
            <th class="px-4 py-2 hidden sm:table-cell">Actions</th>
          </tr>
        </thead>
        <tbody id="logTableBody"></tbody>
      </table>
    </div>
  </main>

  <!-- Description Modal (compat) -->
  <div id="descriptionModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-4 sm:p-6 w-full max-w-md sm:max-w-2xl shadow-xl">
      <h2 class="text-lg font-semibold mb-2">Description</h2>
      <pre id="descriptionContent" class="text-sm whitespace-pre-wrap max-h-96 overflow-y-auto bg-gray-100 p-3 rounded"></pre>
      <button onclick="document.getElementById('descriptionModal').classList.add('hidden')" class="w-full sm:w-auto px-3 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">Close</button>
    </div>
  </div>

  <!-- Team Assign Modal -->
  <div id="assignModal" class="hidden fixed inset-0 bg-black/50 z-50 items-center justify-center p-4">
    <div class="bg-white w-full max-w-4xl rounded-xl shadow-2xl overflow-hidden">
      <div class="bg-indigo-700 text-white px-4 py-3 flex items-center justify-between">
        <div class="font-semibold">üìã Team NTT Assignment ‚Äî <span id="assignTeamTitle"></span></div>
        <button id="assignModalClose" class="bg-white/10 hover:bg-white/20 px-2 py-1 rounded">Close</button>
      </div>
      <div class="p-4 space-y-3">
        <div class="flex items-center justify-between gap-3">
          <input id="assignSearch" type="text" placeholder="Search NTT / Network ID / Symptom" class="flex-1 border rounded px-3 py-2">
          <div class="text-sm flex items-center gap-4">
            <span>Assigned: <b id="assignCount">0</b></span>
            <label class="flex items-center gap-1"><input id="showPool" type="checkbox" class="h-4 w-4" checked><span>Show Pool</span></label>
            <label class="flex items-center gap-1"><input id="showDone" type="checkbox" class="h-4 w-4"><span>Show Done</span></label>
          </div>
        </div>
        <div class="border rounded overflow-hidden">
          <div class="grid grid-cols-12 bg-gray-100 text-xs font-semibold text-gray-700 px-3 py-2">
            <div class="col-span-6">NTT</div>
            <div class="col-span-4">NETWORK ID</div>
            <div class="col-span-2">AGING</div>
          </div>
          <div id="assignList" class="max-h-[65vh] overflow-y-auto divide-y"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- NTT Detail Modal -->
  <div id="nttDetailModal" class="hidden fixed inset-0 z-[60] bg-black/50 items-center justify-center p-3">
    <div class="bg-white w-full max-w-xl rounded-2xl shadow-2xl overflow-hidden">
      <div class="bg-indigo-700 text-white px-4 py-3 flex items-center justify-between">
        <div class="font-semibold">üóÇÔ∏è NTT Log Detail</div>
        <button id="nttDetailClose" class="bg-white/10 hover:bg-white/20 px-2 py-1 rounded">Close</button>
      </div>
      <div class="p-4 space-y-4 text-sm">
        <div class="rounded-lg border border-indigo-200 p-3 bg-indigo-50/40">
          <div class="font-semibold mb-1">üìç Location for: <span id="detailLocationFor" class="font-mono"></span></div>
          <div class="grid grid-cols-1 gap-1">
            <div>Street: <span id="detailStreet" class="font-medium"></span></div>
            <div>Section: <span id="detailSection" class="font-medium"></span></div>
            <div>Coordinates: <a id="detailCoordsLink" href="#" target="_blank" class="text-indigo-600 underline">-</a></div>
          </div>
        </div>
        <div>
          <div class="font-semibold mb-1">Description</div>
          <pre id="detailDescription" class="text-xs whitespace-pre-wrap max-h-80 overflow-y-auto bg-gray-100 p-3 rounded border"></pre>
        </div>
        <div class="text-xs text-gray-600">
          <div>NTT: <b id="detailNttNo"></b></div>
          <div>Assigned: <b id="detailAssignedTo">Unassigned</b></div>
        </div>
        <div class="space-y-2">
          <div class="font-semibold">Upload Evidence:</div>
          <input id="evidenceInput" type="file" class="block w-full text-xs border rounded px-2 py-1">
          <button id="uploadEvidenceBtn" class="w-full sm:w-auto px-3 py-2 text-sm bg-emerald-600 text-white rounded hover:bg-emerald-700">Upload Evidence</button>
          <div id="evidenceStatus" class="text-xs text-gray-600"></div>
        </div>
        <div class="flex items-center justify-between pt-2">
          <button id="resolveBtn" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Resolve NTT</button>
          <div class="text-xs text-gray-500">Mark as <b>Done</b>.</div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    const lastUpdatedEl = document.getElementById("lastUpdated");
    const logTableBody = document.getElementById("logTableBody");
    const filterNode = document.getElementById("filterNode");
    const filterDomain = document.getElementById("filterDomain");
    const filterAging = document.getElementById("filterAging");
    const searchInput = document.getElementById("searchInput");
    const summaryDashboard = document.getElementById("summaryDashboard");
    const toast = document.getElementById("toast");

    /* ===== Centralized Assignments (GitHub CSV) ===== */
    const ASSIGN_REMOTE_RAW = "https://raw.githubusercontent.com/jadyakub/ntt-data/main/ntt_assignments.csv";
    const ASSIGN_SAVE_ENDPOINT = "/.netlify/functions/assignments";
    const ASSIGN_KEY = "nttAssignments";
    const ASSIGN_VER_KEY = "nttAssignmentsVersion";

    function cacheAssignments(map){ localStorage.setItem(ASSIGN_KEY, JSON.stringify(map)); localStorage.setItem(ASSIGN_VER_KEY, String(Date.now())); }
    function readAssignmentsCache(){ try{ return JSON.parse(localStorage.getItem(ASSIGN_KEY)||"{}"); }catch{ return {}; } }

    async function loadAssignmentsRemote() {
      try {
        const res = await fetch(ASSIGN_REMOTE_RAW + "?nocache=" + Date.now(), { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP "+res.status);
        const csv = await res.text();
        const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true });
        const map = {};
        (parsed.data || []).forEach(r => {
          const ntt = (r["NTT Number"]||"").trim();
          if (!ntt) return;
          map[ntt] = {
            team:(r["Team"]||"").trim(),
            status:(r["Status"]||"assigned").trim().toLowerCase(),
            note:r["Note"]||"",
            at:r["UpdatedAt"]||null
          };
        });
        cacheAssignments(map);
        return map;
      } catch(e) {
        return readAssignmentsCache();
      }
    }

    async function upsertAssignmentRemote({ nttNumber, team, status="assigned", note="" }) {
      const optimistic = { team: (team||"").trim(), status: (status||"assigned").toLowerCase(), note: note||"", at: new Date().toISOString() };
      const preCache = readAssignmentsCache();
      preCache[nttNumber] = optimistic;
      cacheAssignments(preCache);

      try {
        const res = await fetch(ASSIGN_SAVE_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nttNumber, team: optimistic.team, status: optimistic.status, note: optimistic.note })
        });
        if (!res.ok) throw new Error(await res.text());
        const { row } = await res.json();
        const cache = readAssignmentsCache();
        cache[nttNumber] = { team: row.Team, status: row.Status.toLowerCase(), note: row.Note, at: row.UpdatedAt };
        cacheAssignments(cache);
        return row;
      } catch (e) {
        showToast("Saved locally (will sync when online)");
        return { Team: optimistic.team, Status: optimistic.status, Note: optimistic.note, UpdatedAt: optimistic.at };
      }
    }

    async function readAssignments(){ return await loadAssignmentsRemote(); }
    function getAssignment(ntt){ return readAssignmentsCache()[ntt] || null; }
    async function saveAssignment(ntt, team, note=""){ await upsertAssignmentRemote({ nttNumber: ntt, team, note, status:"assigned" }); }
    async function setDoneRemote(ntt, done=true){
      const current = getAssignment(ntt) || {};
      await upsertAssignmentRemote({ nttNumber: ntt, team: current.team || "", status: done ? "done" : "assigned" });
    }
    window.addEventListener("storage",(e)=>{ if(e.key===ASSIGN_VER_KEY) applyFilters(); });

    /* ===== Productivity & Evidence ===== */
    const PRODUCTIVITY_KEY="nttProductivity";
    function readProd(){ try{ return JSON.parse(localStorage.getItem(PRODUCTIVITY_KEY)||'{"counts":{},"items":{}}'); }catch{ return {counts:{},items:{}}; } }
    function writeProd(p){ localStorage.setItem(PRODUCTIVITY_KEY, JSON.stringify(p)); }
    function incProductivity(team, ntt){ const p=readProd(); if(p.items[ntt]) return; p.items[ntt]=true; p.counts[team]=(p.counts[team]||0)+1; writeProd(p); }
    function productivityCount(team){ const p=readProd(); return p.counts[team]||0; }
    function evidenceKey(ntt){ return `evidence:${ntt}`; }
    function saveEvidence(ntt, base64, name){ localStorage.setItem(evidenceKey(ntt), JSON.stringify({base64,name,at:new Date().toISOString()})); }
    function readEvidence(ntt){ try{ return JSON.parse(localStorage.getItem(evidenceKey(ntt))||"null"); }catch{return null;} }

    /* ===== Network ID Location ===== */
    const LOCATION_RAW_URL = "https://raw.githubusercontent.com/jadyakub/ntt-data/main/network_id_location.csv";
    let locationIndex=null;
    async function loadLocationIndex(force=false){
      if(locationIndex && !force) return locationIndex;
      try{ const cached=JSON.parse(localStorage.getItem("nttLocationIndex")||"null"); if(cached && Array.isArray(cached.rows)){ locationIndex=cached.rows; return locationIndex; } }catch{}
      const resp=await fetch(LOCATION_RAW_URL+"?nocache="+Date.now(),{cache:"no-store"});
      const text=await resp.text();
      const parsed=Papa.parse(text,{header:true,skipEmptyLines:true});
      locationIndex=(parsed.data||[]).map(r=>({networkId:(r["Network ID"]||"").trim(),locationFor:(r["Network ID"]||"").trim(),street:r["Street Name"]||"",section:r["Section"]||"",lat:(r["Latitude"]||"").toString().trim(),lng:(r["Longitude"]||"").toString().trim()}));
      localStorage.setItem("nttLocationIndex", JSON.stringify({rows:locationIndex, at:Date.now()}));
      return locationIndex;
    }
    function findLocationByNetworkId(nid){ if(!locationIndex) return null; return locationIndex.find(r=>r.networkId===(nid||"").trim())||null; }

    /* ===== Data ===== */
    let fullData=[]; let currentFilteredData=[];
    let currentDetailRecord=null;
    let currentAssignTeam=null;
    const allowedNodes=["KGU","TBN","SOO","NBN","TNM"];
    const REPO_RAW_URL="https://raw.githubusercontent.com/jadyakub/ntt-data/main/ntt_logs.csv";
    const AUTO_REFRESH_SECONDS=30;
    const nowStr=()=>new Date().toLocaleString();
    const cloudUrl=()=>REPO_RAW_URL+"?nocache="+Date.now();
    function showToast(msg){ if(!toast) return; toast.textContent=msg; toast.classList.add("show"); setTimeout(()=>toast.classList.remove("show"),1800); }

    /* ===== Telegram Notify Helper (tanpa viewUrl) ===== */
    async function sendTelegramResolved(record){
      if(!record) return;
      const payload = {
        nttNumber: record["NTT Number"],
        team: (getAssignment(record["NTT Number"])||{}).team || "UNKNOWN",
        node: record["TM Node"],
        networkId: record["Network ID"],
        aging: record["Aging Category"] || "-"
      };
      let res = await fetch("/api/notify-telegram", {
        method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload)
      });
      if(!res.ok){
        res = await fetch("/.netlify/functions/notify-telegram", {
          method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload)
        });
      }
      if(!res.ok){
        console.error("Telegram notify failed:", await res.text());
        showToast("Failed to notify Telegram");
      } else {
        showToast("Resolved & notified to Telegram");
      }
    }

    /* ===== Tabs show/hide ===== */
    function setupTabs() {
      const buttons = Array.from(document.querySelectorAll('#dashTabs .tabbtn'));
      const sections = {
        summaryGrid: document.getElementById('summaryGrid'),
        nttSummary: document.getElementById('nttSummary'),
        zoneCard: document.getElementById('zoneCard'),
        teamQuick: document.getElementById('teamQuickPanel'),
        summaryDashboard: document.getElementById('summaryDashboard')
      };

      function showOnly(which) {
        if (which === 'summary') {
          sections.summaryGrid.classList.remove('hidden');
          sections.nttSummary.classList.remove('hidden');
          sections.zoneCard.classList.remove('hidden');
          sections.teamQuick.classList.remove('hidden');
          sections.summaryDashboard.classList.add('hidden');
        } else if (which === 'zoneOnly') {
          sections.summaryGrid.classList.remove('hidden');
          sections.nttSummary.classList.add('hidden');
          sections.teamQuick.classList.add('hidden');
          sections.zoneCard.classList.remove('hidden');
          sections.summaryDashboard.classList.add('hidden');
        } else if (which === 'summaryDashboard') {
          sections.summaryGrid.classList.add('hidden');
          sections.summaryDashboard.classList.remove('hidden');
        }
        buttons.forEach(b => b.classList.toggle('active', b.dataset.show===which));
      }

      showOnly('summary'); // default
      buttons.forEach(btn => btn.addEventListener('click', () => showOnly(btn.dataset.show)));
    }

    document.addEventListener("visibilitychange",()=>{ if(!document.hidden) refreshFromGitHub(); });

    window.addEventListener("DOMContentLoaded", async ()=>{
      await refreshFromGitHub(true);
      await readAssignments();
      setInterval(refreshFromGitHub, AUTO_REFRESH_SECONDS*1000);
      [filterNode,filterDomain,filterAging,searchInput].forEach(el=>el.addEventListener("input",applyFilters));
      setupTabs();

      // Detail modal close
      document.getElementById("nttDetailClose").addEventListener("click", ()=>{
        const m=document.getElementById("nttDetailModal");
        m.classList.add("hidden"); m.classList.remove("flex");
      });

      // Resolve (confirmation)
      document.getElementById("resolveBtn").addEventListener("click", async ()=>{
        if(!currentDetailRecord) return;
        const ntt=currentDetailRecord["NTT Number"];
        if(!confirm(`Confirm resolve ${ntt}?`)) return;

        const a=getAssignment(ntt);
        await setDoneRemote(ntt,true);
        if(a && a.team) incProductivity(a.team, ntt);
        await sendTelegramResolved(currentDetailRecord);

        const m=document.getElementById("nttDetailModal");
        m.classList.add("hidden"); m.classList.remove("flex");
        applyFilters();
      });

      // Assign modal close
      document.getElementById("assignModalClose").addEventListener("click", ()=>{
        const m=document.getElementById("assignModal");
        m.classList.add("hidden"); m.classList.remove("flex");
      });

      // live controls in assign modal
      document.getElementById("assignSearch").addEventListener("input", ()=>renderAssignList());
      document.getElementById("showPool").addEventListener("change", ()=>renderAssignList());
      document.getElementById("showDone").addEventListener("change", ()=>renderAssignList());
    });

    function syncNow(){ showToast("Syncing from GitHub‚Ä¶"); refreshFromGitHub(true); }

    async function refreshFromGitHub(firstLoad=false){
      try{
        const resp=await fetch(cloudUrl(),{cache:"no-store"});
        if(!resp.ok) throw new Error("HTTP "+resp.status);
        const csvText=await resp.text();
        const parsed=Papa.parse(csvText,{header:true,skipEmptyLines:true});
        const data=(parsed.data||[]).map(row=>({
          "NTT Create Date":row["NTT Create Date"],"NTT Number":row["NTT Number"],
          "TM Node":(row["TM Node"]||"").trim().toUpperCase(),"Symptom":row["Symptom"],
          "Domain":(row["Domain"]||"").trim(),"Network ID":row["Network ID"],"CTTs Linked":row["CTTs Linked"],
          "Aging Category":(row["Aging Category"]||"").trim(),"Zone":(row["Zone"]||"").trim().toUpperCase(),
          "Description":row["Description"]
        })).filter(r=>allowedNodes.includes(r["TM Node"]));
        fullData=data; localStorage.setItem("nttData",JSON.stringify(fullData));
        populateFilters(fullData); applyFilters();
        lastUpdatedEl.textContent="Last updated: "+nowStr();
        lastUpdatedEl.className="text-sm text-green-100"; if(!firstLoad) showToast("Data refreshed");
      }catch(e){
        const cached=localStorage.getItem("nttData");
        if(cached){ fullData=JSON.parse(cached); populateFilters(fullData); applyFilters();
          lastUpdatedEl.textContent="Using cache (GitHub not reachable): "+nowStr(); lastUpdatedEl.className="text-sm text-yellow-200"; showToast("Using cache");
        } else { lastUpdatedEl.textContent="Failed to load from GitHub: "+e.message; lastUpdatedEl.className="text-sm text-red-200"; showToast("Failed to load data"); }
      }
    }

    function getDayDifference(dateStr){ const t=new Date(), d=new Date(dateStr); if(isNaN(d.getTime())) return NaN; return Math.floor((t-d)/(1000*60*60*24)); }

    async function openDetail(record){
      currentDetailRecord = record;
      await loadLocationIndex();

      const loc = findLocationByNetworkId(record["Network ID"]);
      document.getElementById("detailLocationFor").textContent = record["Network ID"] || "-";
      document.getElementById("detailStreet").textContent = (loc && loc.street) || "-";
      document.getElementById("detailSection").textContent = (loc && loc.section) || "-";
      const link = document.getElementById("detailCoordsLink");
      if(loc && loc.lat && loc.lng){
        link.textContent = `${loc.lat}, ${loc.lng}`;
        link.href = `https://maps.google.com/?q=${loc.lat},${loc.lng}`;
      } else {
        link.textContent = "-";
        link.href = "#";
      }
      document.getElementById("detailDescription").textContent = record["Description"] || "-";
      document.getElementById("detailNttNo").textContent = record["NTT Number"] || "-";
      const a = getAssignment(record["NTT Number"]);
      document.getElementById("detailAssignedTo").textContent = (a && a.team) ? a.team : "Unassigned";

      const m=document.getElementById("nttDetailModal");
      m.classList.remove("hidden"); m.classList.add("flex");
    }

    function agingBadge(cat){
      let c="bg-green-500";
      if((cat||"").includes("24H - 48H")) c="bg-red-500";
      else if((cat||"").includes("12H - 24H")) c="bg-orange-500";
      else if((cat||"").includes("8H - 12H")) c="bg-yellow-500";
      return `<span class="inline-block text-[10px] px-2 py-0.5 rounded text-white ${c}">${cat||"-"}</span>`;
    }

    function populateTable(data){
      const TEAM_LIST_LOCAL = ["TEAM FAISON","TEAM FAUZIE","TEAM RUDI","TEAM ROSDEE"];
      let out = [];
      for(const row of data){
        const ageCat = row["Aging Category"] || "";
        const agingClass = ageCat.includes("48H")?"bg-red-500":(ageCat.includes("24H")?"bg-orange-400":"bg-green-500");
        const daysCount = getDayDifference(row["NTT Create Date"]);
        const asg = getAssignment(row["NTT Number"]);

        const stat = asg && asg.status ? asg.status : "assigned";
        const statusLabel = (stat==="done")?"RESOLVED":(stat==="in progress"?"IN PROGRESS":(stat==="unassigned"?"UNASSIGNED":"ASSIGNED"));
        const badgeClass =
          (stat==="done")?"bg-emerald-100 text-emerald-700":
          (stat==="in progress")?"bg-amber-100 text-amber-700":
          (stat==="unassigned")?"bg-gray-100 text-gray-600":"bg-indigo-100 text-indigo-700";
        const statusBadge = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold ${badgeClass}">${statusLabel}</span>`;

        const assigneeBadge = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold ${asg&&asg.team?'bg-purple-100 text-purple-700':'bg-gray-100 text-gray-600'}">${asg&&asg.team?asg.team:'UNASSIGNED'}</span>`;

        const teamSelect = `<select class="assigneeSelect border rounded px-2 py-1 text-sm" data-ntt="${row["NTT Number"]||''}">
          ${TEAM_LIST_LOCAL.map(t=>`<option value="${t}" ${(asg&&asg.team===t)?'selected':''}>${'Team '+t.split(' ')[1].slice(0,1)+t.split(' ')[1].slice(1).toLowerCase()}</option>`).join('')}
        </select>`;

        const statusSelect = `<select class="statusSelect border rounded px-2 py-1 text-sm ml-2" data-ntt="${row["NTT Number"]||''}">
          <option value="UNASSIGNED" ${stat==='unassigned'?'selected':''}>UNASSIGNED</option>
          <option value="ASSIGNED" ${stat==='assigned' || !asg?'selected':''}>ASSIGNED</option>
          <option value="IN PROGRESS" ${stat==='in progress'?'selected':''}>IN PROGRESS</option>
          <option value="RESOLVED" ${stat==='done'?'selected':''}>RESOLVED</option>
        </select>`;

        const inlineBadge = asg && asg.team ? `<span class="ml-2 text-[10px] px-2 py-0.5 rounded bg-indigo-600 text-white">${asg.team}${stat==="done"?" ‚Ä¢ done":""}</span>` : "";

        out.push(`
          <tr class="border-b hover:bg-gray-50">
            <td class="px-4 py-2">${row["NTT Create Date"]||""}</td>
            <td class="px-4 py-2">
              <button class="text-indigo-600 underline open-detail"
                      data-ntt="${row["NTT Number"]||""}">
                ${row["NTT Number"]||""}
              </button>
              ${inlineBadge}
            </td>
            <td class="px-4 py-2">${row["TM Node"]||""}</td>
            <td class="px-4 py-2">${row["Symptom"]||""}</td>
            <td class="px-4 py-2">${row["Domain"]||""}</td>
            <td class="px-4 py-2">${row["Network ID"]||""}</td>
            <td class="px-4 py-2">${row["CTTs Linked"]||""}</td>
            <td class="px-4 py-2"><span class="px-2 py-1 rounded text-white ${agingClass}">${ageCat}</span></td>
            <td class="px-4 py-2">${isFinite(daysCount)?daysCount:"-"}</td>
            <td class="px-4 py-2 hidden sm:table-cell">${assigneeBadge}</td>
            <td class="px-4 py-2 hidden sm:table-cell">${statusBadge}</td>
            <td class="px-4 py-2 hidden sm:table-cell">${teamSelect}${statusSelect}</td>
          </tr>
        `);
      }
      logTableBody.innerHTML = out.join("");

      // Buka NTT Detail Modal
      logTableBody.querySelectorAll('.open-detail').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const ntt = btn.getAttribute('data-ntt');
          const rec = (fullData||[]).find(r => r["NTT Number"]===ntt);
          if(rec) openDetail(rec);
        });
      });

      // Team change
      logTableBody.querySelectorAll('.assigneeSelect').forEach(sel=>{
        sel.addEventListener('change', async ()=>{
          const ntt = sel.getAttribute('data-ntt');
          const team = sel.value;
          const current = getAssignment(ntt);
          const nextStatus = (!current || current.status === "unassigned") ? "assigned" : (current.status || "assigned");
          await upsertAssignmentRemote({ nttNumber: ntt, team, status: nextStatus, note: (current && current.note) || "" });
          if(current && current.status === "done"){ await setDoneRemote(ntt, true); }
          applyFilters();
          showToast('Assignee updated');
        });
      });

      // Status change + confirm
      logTableBody.querySelectorAll('.statusSelect').forEach(sel=>{
        sel.addEventListener('change', async ()=>{
          const ntt = sel.getAttribute('data-ntt');
          const desired = sel.value;
          let a = getAssignment(ntt);

          if(desired === 'RESOLVED'){
            if(!confirm(`Confirm resolve ${ntt}?`)){ sel.value='ASSIGNED'; return; }
          }

          if(!a && desired !== 'UNASSIGNED'){
            await saveAssignment(ntt, ["TEAM FAISON","TEAM FAUZIE","TEAM RUDI","TEAM ROSDEE"][0], "");
            a = getAssignment(ntt);
          }

          if(desired === 'RESOLVED'){
            await setDoneRemote(ntt, true);
            if(a && a.team) incProductivity(a.team, ntt);
            const rec = (fullData||[]).find(r=>r["NTT Number"]===ntt);
            if(rec) await sendTelegramResolved(rec);
          } else if(desired === 'UNASSIGNED'){
            await upsertAssignmentRemote({ nttNumber: ntt, team: "", status: "unassigned", note: (a && a.note) || "" });
          } else {
            const teamVal = (a && a.team) ? a.team : ["TEAM FAISON","TEAM FAUZIE","TEAM RUDI","TEAM ROSDEE"][0];
            const statusVal = (desired === 'IN PROGRESS') ? 'in progress' : 'assigned';
            await upsertAssignmentRemote({ nttNumber: ntt, team: teamVal, status: statusVal, note: (a && a.note) || "" });
          }

          applyFilters();
          showToast('Status updated');
        });
      });
    }

    function populateFilters(data){
      const domainSet=new Set(data.map(d=>(d["Domain"]||"").trim()).filter(Boolean));
      domainSet.add("LTE 4G");
      const domains=[...domainSet].sort();
      const agings=[...new Set(data.map(d=>(d["Aging Category"]||"").trim()).filter(Boolean))].sort();
      filterDomain.innerHTML='<option value="">Filter by Domain</option>'+domains.map(d=>`<option value="${d}">${d}</option>`).join('');
      filterAging.innerHTML='<option value="">Filter by Aging</option>'+agings.map(a=>`<option value="${a}">${a}</option>`).join('');
    }

    function applyFilters(){
      const node=filterNode.value, domain=filterDomain.value, aging=filterAging.value, keyword=(searchInput.value||"").toLowerCase();
      const filtered=fullData.filter(row=>{
        const okNode=!node||(row["TM Node"]||"")===node;
        const okDomain=!domain||(row["Domain"]||"")===domain;
        const okAging=!aging||(row["Aging Category"]||"")===aging;
        const okSearch=!keyword||Object.values(row).some(v=>String(v||"").toLowerCase().includes(keyword));
        return okNode&&okDomain&&okAging&&okSearch;
      });
      currentFilteredData=filtered;
      populateTable(filtered);
      populateDashboard(filtered);
      updateNTTSummary(filtered);
      populateZoneDashboard(filtered);
      renderTeamQuickPanel(filtered);
    }

    function toggleTeam(teamId){
      const section=document.getElementById(teamId);
      if(section){
        section.classList.toggle("hidden");
        const btn = section.parentElement.querySelector('button .chev');
        if (btn) btn.textContent = section.classList.contains('hidden') ? '‚ñ∏' : '‚ñæ';
      }
    }

    const TEAM_ALIASES={"TEAM FAISON":["TEAM FAISON"],"TEAM FAUZIE":["TEAM FAUZIE"],"TEAM RUDI":["TEAM RUDI"],"TEAM ROSDEE":["TEAM ROSDEE"]};
    const TEAM_LIST = ["TEAM FAISON","TEAM FAUZIE","TEAM RUDI","TEAM ROSDEE"];
    const TEAM_NODES = {"TEAM FAISON":["KGU","TBN"],"TEAM FAUZIE":["KGU","TBN"],"TEAM RUDI":["SOO","NBN"],"TEAM ROSDEE":["TNM"]};

    function teamsMatch(entryTeam, cardTeam){ const aliases=TEAM_ALIASES[cardTeam]||[cardTeam]; return aliases.includes(entryTeam); }

    function populateDashboard(data){
      const teams=TEAM_NODES;
      summaryDashboard.innerHTML="";
      const assignments=readAssignmentsCache();

      Object.entries(teams).forEach(([team,nodes])=>{
        const teamId=team.replace(/\s+/g,"_");

        const assignedOpen = data.filter(d=>{
          const a=assignments[d["NTT Number"]];
          return a && teamsMatch(a.team, team) && a.status!=="done" && a.status!=="unassigned";
        }).length;
        const done = data.filter(d=>{
          const a=assignments[d["NTT Number"]];
          return a && teamsMatch(a.team, team) && a.status==="done";
        }).length;
        const totalTeam = assignedOpen + done;
        const prod=productivityCount(team);
        const pct = totalTeam ? Math.round((done/totalTeam)*100) : 0;

        let html = `
          <div class="rounded-lg border border-gray-200 p-3 bg-white shadow-sm">
            <div class="flex items-center justify-between">
              <div class="font-semibold text-gray-800">${team}</div>
              <div class="text-xs text-gray-500">Total: <b>${totalTeam}</b></div>
            </div>

            <div class="mt-2">
              <div class="h-2 bg-gray-200 rounded">
                <div class="h-2 bg-emerald-500 rounded" style="width:${pct}%;"></div>
              </div>
              <div class="mt-1 flex flex-wrap gap-2 text-xs">
                <span class="inline-flex items-center px-2 py-0.5 rounded bg-indigo-100 text-indigo-700">Assigned: ${assignedOpen}</span>
                <span class="inline-flex items-center px-2 py-0.5 rounded bg-emerald-100 text-emerald-700">Done: ${done}</span>
                <span class="inline-flex items-center px-2 py-0.5 rounded bg-sky-100 text-sky-700">Productivity: ${prod}</span>
              </div>
            </div>

            <div class="mt-3 flex items-center justify-between">
              <button class="text-xs px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 flex items-center gap-1"
                      onclick="toggleTeam('${teamId}')">
                <span class="chev">‚ñ∏</span> Details
              </button>
              <button data-team="${team}" class="open-assign-modal bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
                Task Assign
              </button>
            </div>

            <div id="${teamId}" class="team-section hidden mt-3">
              ${nodes.map(node=>{
                const a8   = data.filter(d=>d["TM Node"]===node && d["Aging Category"]==="< 8H").length;
                const a12  = data.filter(d=>d["TM Node"]===node && d["Aging Category"]==="8H - 12H").length;
                const a24  = data.filter(d=>d["TM Node"]===node && d["Aging Category"]==="12H - 24H").length;
                const a48  = data.filter(d=>d["TM Node"]===node && d["Aging Category"]==="24H - 48H").length;
                const a48p = data.filter(d=>d["TM Node"]===node && d["Aging Category"]==="> 48H").length;
                const tot  = a8+a12+a24+a48+a48p;

                return `
                  <div class="mb-2">
                    <div class="text-xs font-semibold text-gray-700 mb-1">${node} ‚Ä¢ Total ${tot}</div>
                    <div class="grid grid-cols-5 gap-2 text-[11px]">
                      <div class="px-2 py-1 rounded bg-gray-100">üü¢ &lt;8H: ${a8}</div>
                      <div class="px-2 py-1 rounded bg-gray-100">üü° 8‚Äì12H: ${a12}</div>
                      <div class="px-2 py-1 rounded bg-gray-100">üî∂ 12‚Äì24H: ${a24}</div>
                      <div class="px-2 py-1 rounded bg-orange-400 text-white">24‚Äì48H: ${a48}</div>
                      <div class="px-2 py-1 rounded bg-red-500 text-white">&gt;48H: ${a48p}</div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;

        summaryDashboard.insertAdjacentHTML('beforeend', html);
      });

      summaryDashboard.querySelectorAll('.open-assign-modal').forEach(btn=>{
        btn.addEventListener('click',()=>openAssignModal(btn.getAttribute('data-team')));
      });
    }

    function updateNTTSummary(data){
      const cfg=[
        {label:"< 8H", ring:"ring-green-400", text:"text-green-600"},
        {label:"8H - 12H", ring:"ring-yellow-400", text:"text-yellow-600"},
        {label:"12H - 24H", ring:"ring-orange-400", text:"text-orange-500"},
        {label:"24H - 48H", ring:"ring-red-400", text:"text-red-500"},
        {label:"> 48H", ring:"ring-rose-400", text:"text-rose-600"}
      ];
      const c=document.getElementById("nttSummaryContainer");
      c.innerHTML="";
      const frag=document.createDocumentFragment();

      cfg.forEach(cat=>{
        const list=data.filter(d=>(d["Aging Category"]||"")===cat.label);
        const count=list.length;
        const overdue=(cat.label==="> 48H") ? list.filter(d=>getDayDifference(d["NTT Create Date"])>2).length : 0;

        const w=document.createElement('button');
        w.type="button";
        w.className='flex flex-col items-center focus:outline-none';
        w.innerHTML=`
          <div class="w-20 h-20 rounded-xl ring-4 ${cat.ring} flex items-center justify-center text-xl font-bold text-gray-800 bg-white">${count}</div>
          <span class="text-xs mt-2 ${cat.text}">${cat.label}${overdue?` ‚Ä¢ overdue: ${overdue}`:""}</span>
        `;
        w.addEventListener('click', ()=>{
          filterAging.value = cat.label;
          applyFilters();
          const teamBtn = document.querySelector('#dashTabs [data-show="summaryDashboard"]');
          if (teamBtn) teamBtn.click();
          document.getElementById('summaryDashboard')?.scrollIntoView({ behavior:'smooth', block:'start' });
        });
        frag.appendChild(w);
      });
      c.appendChild(frag);
    }

    function populateZoneDashboard(data){
      const targetZone="PBP SELATAN", targetDomain="PASSIVE ELEMENT NOVA", nodes=["KGU","TBN","SOO","NBN","TNM"];
      const filtered=data.filter(d=>String(d["Zone"]||"").trim().toUpperCase()===targetZone && String(d["Domain"]||"").trim().toUpperCase()===targetDomain && nodes.includes(String(d["TM Node"]||"").trim().toUpperCase()));
      const barWrap=document.getElementById("zoneDashboard");
      const grand=document.getElementById("zoneGrand");

      if(!filtered.length){
        barWrap.innerHTML='<div class="text-sm text-gray-500 italic py-2 px-3 bg-yellow-100 border border-yellow-300 rounded">‚ùó No Passive Element NTT found.</div>';
        grand.innerHTML=''; return;
      }

      const counts=Object.fromEntries(nodes.map(n=>[n,0]));
      filtered.forEach(r=>{ const n=String(r["TM Node"]||"").trim().toUpperCase(); if(n in counts) counts[n]++; });
      const sorted=Object.entries(counts).sort((a,b)=>b[1]-a[1]);
      const max=Math.max(...sorted.map(([,c])=>c),1);

      barWrap.innerHTML=sorted.map(([n,cnt])=>`
        <div class="flex items-center gap-3">
          <div class="w-14 text-sm font-medium">${n}</div>
          <div class="flex-1 bg-gray-200 rounded h-4 relative overflow-hidden">
            <div class="bg-red-500 h-4" style="width:${cnt/max*100}%"></div>
            <span class="absolute right-2 top-0 text-white text-xs font-bold leading-4">${cnt}</span>
          </div>
        </div>
      `).join("");

      const total=sorted.reduce((s,[,c])=>s+c,0);
      grand.innerHTML = `<div>Grand Total</div><div>${total}</div>`;
    }

    /* Team Quick Panel */
    function renderTeamQuickPanel(data){
      const teams = TEAM_NODES;
      const colorByNode = { KGU:'bg-amber-400', TBN:'bg-orange-500', SOO:'bg-emerald-600', NBN:'bg-green-600', TNM:'bg-rose-500' };
      const el = document.getElementById('teamQuickPanel');
      el.innerHTML = '';

      Object.entries(teams).forEach(([team, nodes])=>{
        const chips = nodes.map(n=>{
          const cnt = data.filter(d=>d['TM Node']===n).length;
          const col = colorByNode[n] || 'bg-gray-400';
          return `<span class="pill text-white ${col}">${n} ${cnt}</span>`;
        }).join(' ');

        const card = document.createElement('div');
        card.className = 'card-soft p-4';
        card.innerHTML = `
          <div class="text-base font-semibold text-gray-800 mb-3">${team}</div>
          <div class="flex items-center justify-between">
            <div class="flex flex-wrap gap-2">${chips}</div>
            <button class="expandBtn text-gray-700 bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded">Expand</button>
          </div>
        `;
        card.querySelector('.expandBtn').addEventListener('click', ()=>{
          document.querySelector('#dashTabs [data-show="summaryDashboard"]').click();
          setTimeout(()=>{
            const teamId = team.replace(/\s+/g,'_');
            const sec = document.getElementById(teamId);
            if(sec && sec.classList.contains('hidden')) sec.classList.remove('hidden');
            document.getElementById('summaryDashboard')?.scrollIntoView({behavior:'smooth'});
          }, 50);
        });

        el.appendChild(card);
      });
    }

    /* ===== Assignment Modal ===== */
    function openAssignModal(teamName){
      currentAssignTeam = teamName;
      document.getElementById("assignTeamTitle").textContent = teamName;
      document.getElementById("assignSearch").value = "";
      document.getElementById("showPool").checked = true;
      document.getElementById("showDone").checked = false;
      renderAssignList();

      const m=document.getElementById("assignModal");
      m.classList.remove("hidden"); m.classList.add("flex");
    }

    function renderAssignList(){
      const team = currentAssignTeam;
      if(!team) return;

      const nodes = TEAM_NODES[team]||[];
      const assignments = readAssignmentsCache();
      const search = (document.getElementById("assignSearch").value||"").toLowerCase();
      const showPool = document.getElementById("showPool").checked;
      const showDone = document.getElementById("showDone").checked;

      const source = fullData.filter(r=>nodes.includes(r["TM Node"]));
      const list = source.filter(r=>{
        const a = assignments[r["NTT Number"]];
        const isUnassigned = !a || a.status==="unassigned" || !a.team;
        const isDone = a && a.status==="done";
        if(!showPool && isUnassigned) return false;
        if(!showDone && isDone) return false;
        if(!search) return true;
        return [r["NTT Number"], r["Network ID"], r["Symptom"]].some(v=>String(v||"").toLowerCase().includes(search));
      });

      // count current team active
      const assignedCount = source.filter(r=>{
        const a=assignments[r["NTT Number"]];
        return a && teamsMatch(a.team,team) && a.status!=="done" && a.status!=="unassigned";
      }).length;
      document.getElementById("assignCount").textContent = assignedCount;

      const wrap = document.getElementById("assignList");
      wrap.innerHTML = list.map(r=>{
        const a = assignments[r["NTT Number"]];
        const isMine = a && teamsMatch(a.team,team) && a.status!=="done" && a.status!=="unassigned";
        const isUnassigned = !a || a.status==="unassigned" || !a.team;
        const isDone = a && a.status==="done";
        const rowBg = isDone ? "bg-gray-50" : (isMine ? "bg-yellow-50" : "bg-white");

        return `
          <div class="grid grid-cols-12 items-center px-3 py-2 cursor-pointer hover:bg-indigo-50 ${rowBg}"
               data-ntt="${r["NTT Number"]}">
            <div class="col-span-6">
              <a href="#" class="openInDetail text-indigo-600 underline">${r["NTT Number"]}</a>
              <div class="text-[11px] text-gray-500">${(r["Symptom"]||"").slice(0,80)}</div>
            </div>
            <div class="col-span-4 font-mono">${r["Network ID"]||"-"}</div>
            <div class="col-span-2 text-right">${agingBadge(r["Aging Category"])}</div>
          </div>
        `;
      }).join("");

      // click a row toggles assign/unassign; clicking link opens detail (stopPropagation)
      wrap.querySelectorAll('.openInDetail').forEach(a=>{
        a.addEventListener('click', (ev)=>{
          ev.preventDefault();
          ev.stopPropagation();
          const ntt = a.closest('[data-ntt]').getAttribute('data-ntt');
          const rec = fullData.find(x=>x["NTT Number"]===ntt);
          if(rec) openDetail(rec);
        });
      });

      wrap.querySelectorAll('[data-ntt]').forEach(row=>{
        row.addEventListener('click', async ()=>{
          const ntt=row.getAttribute('data-ntt');
          const current = getAssignment(ntt);
          const isMine = current && teamsMatch(current.team,team) && current.status!=="done" && current.status!=="unassigned";
          if(isMine){
            await upsertAssignmentRemote({ nttNumber: ntt, team: "", status: "unassigned", note: (current && current.note)||"" });
          } else {
            await upsertAssignmentRemote({ nttNumber: ntt, team: team, status: "assigned", note: (current && current.note)||"" });
          }
          renderAssignList();
          applyFilters();
        });
      });
    }
  </script>
</body>
</html>
